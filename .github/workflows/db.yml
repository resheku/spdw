name: db

on:
    workflow_run:
        workflows: ["sel data"]
        types:
            - completed
    workflow_dispatch:
env:
  DATA_BRANCH: sel

jobs:
    data:
        runs-on: ubuntu-latest
        steps:
            - name: checkout data branch
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DATA_BRANCH }}
            - name: install duckdb
              uses: opt-nc/setup-duckdb-action@v1.0.8
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4.1.0
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ${{ secrets.AWS_REGION }}
            - name: db export directory
              run: mkdir -p parquet && ls -lah parquet/*
            - name: db export
              run: duckdb sel.db -c "EXPORT DATABASE 'parquet' (FORMAT parquet);"
            - name: db upload
              env:
                BUCKET: ${{ secrets.AWS_BUCKET_NAME }}
                ENDPOINT: ${{ secrets.AWS_ENDPOINT_URL }}
                REGION: ${{ secrets.AWS_REGION }}
              run: |
                aws s3 cp --recursive parquet/ s3://$BUCKET \
                  --region $REGION \
                  --endpoint-url $ENDPOINT